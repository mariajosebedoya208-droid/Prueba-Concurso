# -*- coding: utf-8 -*-
"""Analisis_Portafolios.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OHRI3VCCTIOc3M4eLd18hLDRVqrlBv_n
"""

#!pip install streamlit pandas numpy yfinance matplotlib plotly

#Importaci√≥n las librer√≠as

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import matplotlib.pyplot as plt
import warnings
import plotly.graph_objects as go
import plotly.express as px
from io import BytesIO
from reportlab.lib.pagesizes import letter
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet

warnings.filterwarnings('ignore')

st.markdown("<h1 style='text-align: center; color:#004aad;'>Smart Portafolio - Simulaci√≥n de Escenarios</h1>", unsafe_allow_html=True)

st.write("""
Esta aplicaci√≥n realiza una **simulaci√≥n de escenarios de inversi√≥n**, aplicando la *Teor√≠a Moderna de Portafolios de Markowitz*.

Se analizan tres tipos de portafolios seg√∫n el perfil de riesgo del inversionista:

- üü© **Conservador:** prioriza la estabilidad, minimizando el riesgo.  
- üü® **Moderado:** busca equilibrio entre riesgo y rentabilidad.  
- üü• **Agresivo:** asume un riesgo alto para intentar maximizar las ganancias.

Los datos se obtienen directamente desde **Yahoo Finance**, permitiendo analizar empresas reales del mercado financiero.
""")

# Configuraci√≥n de entradas

st.sidebar.markdown("## ‚öôÔ∏è Configuraci√≥n del An√°lisis")

# Entrada libre de tickers
tickers_input = st.sidebar.text_input(
    "Empresas (separa por comas):",
    value="AAPL, MSFT, TSLA"
)

# Convertir texto en lista
tickers = [t.strip().upper() for t in tickers_input.split(",") if t.strip() != ""]

# Rango de fechas
fecha_inicio = st.sidebar.date_input("üìÖ Fecha Inicial", pd.to_datetime("2020-01-01"))
fecha_fin = st.sidebar.date_input("üìÖ Fecha Final", pd.to_datetime("2023-12-31"))

# Inversi√≥n inicial
inversion_inicial = st.sidebar.number_input("üí∞ Inversi√≥n Inicial (USD)", min_value=1000, value=10000, step=500)

# Frecuencia temporal
frecuencia = st.sidebar.selectbox("‚è±Ô∏è Frecuencia Temporal", ["Diaria", "Semanal", "Mensual"])

# Bot√≥n para ejecutar
descargar = st.sidebar.button("üì• Descargar y Analizar")

# Validaci√≥n de tickers
def validar_tickers(tickers):
    tickers_validos = []
    for ticker in tickers:
        try:
            info = yf.Ticker(ticker).info
            if info.get('regularMarketPrice') is not None:
                tickers_validos.append(ticker)
            else:
                st.warning(f"‚ö†Ô∏è Ticker {ticker} no encontrado en Yahoo Finance")
        except:
            st.warning(f"‚ö†Ô∏è Error al validar ticker {ticker}")
    return tickers_validos

# Ejecutar an√°lisis al hacer clic
if descargar:
    if len(tickers) == 0:
        st.error("‚ùå Por favor ingresa al menos un ticker v√°lido")
        st.stop()
    
    tickers = validar_tickers(tickers)
    
    if len(tickers) == 0:
        st.error("‚ùå No se encontraron tickers v√°lidos")
        st.stop()

    # Descargar datos
    with st.spinner('üì• Descargando datos...'):
        data = yf.download(tickers, start=fecha_inicio, end=fecha_fin)["Close"]
    
    # Mostrar datos
    st.subheader("üìä Datos Descargados")
    st.dataframe(data.tail())

    # Ajustar frecuencia
    if frecuencia == "Semanal":
        data = data.resample('W').last()
    elif frecuencia == "Mensual":
        data = data.resample('M').last()

    # Input de pesos personalizados
    st.sidebar.markdown("### üéØ Configuraci√≥n de Pesos")
    opcion_pesos = st.sidebar.radio(
        "M√©todo de asignaci√≥n:",
        ["Escenario Predefinido", "Pesos Personalizados"]
    )

    if opcion_pesos == "Escenario Predefinido":
        escenario = st.sidebar.selectbox("üí∞ Escenario de Inversi√≥n", ["Conservador", "Moderado", "Agresivo"])
        escenarios = {
            "Conservador": np.linspace(0.6, 0.1, len(tickers)),
            "Moderado": np.linspace(0.4, 0.2, len(tickers)),
            "Agresivo": np.linspace(0.2, 0.6, len(tickers))
        }
        weights = escenarios[escenario]
        weights = weights / np.sum(weights)
    else:
        st.sidebar.markdown("### üî¢ Asigna Pesos Manualmente")
        pesos_manuales = []
        total = 0
        for i, ticker in enumerate(tickers):
            peso = st.sidebar.slider(f"Peso para {ticker}", 0.0, 1.0, 1.0/len(tickers), 0.01)
            pesos_manuales.append(peso)
            total += peso
        
        if abs(total - 1.0) > 0.01:
            st.sidebar.warning(f"‚ö†Ô∏è La suma de pesos es {total:.2f}. Normalizando...")
            weights = np.array(pesos_manuales) / total
        else:
            weights = np.array(pesos_manuales)
        
        escenario = "Personalizado"

    # C√°lculos del portafolio
    returns = data.pct_change().dropna()
    mean_returns = returns.mean() * 252
    cov_matrix = returns.cov() * 252

    port_return = np.dot(weights, mean_returns)
    port_volatility = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights)))
    sharpe_ratio = port_return / port_volatility

    returns["Portfolio"] = (returns[tickers] * weights).sum(axis=1)
    valor_portafolio = (1 + returns["Portfolio"]).cumprod() * inversion_inicial

    # M√©tricas en columnas
    st.subheader("üéØ Resumen Ejecutivo")
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Rendimiento Esperado", f"{port_return:.2%}")
    with col2:
        st.metric("Volatilidad Anual", f"{port_volatility:.2%}")
    with col3:
        st.metric("Ratio de Sharpe", f"{sharpe_ratio:.2f}")
    with col4:
        st.metric("Escenario", escenario)

    # Visualizaci√≥n de Precios
    st.subheader("üìà Evoluci√≥n de Precios")
    fig1 = go.Figure()
    for ticker in tickers:
        fig1.add_trace(go.Scatter(x=data.index, y=data[ticker], mode='lines', name=ticker))
    fig1.update_layout(title="Evoluci√≥n de Precios Ajustados", xaxis_title="Fecha", yaxis_title="Precio (USD)")
    st.plotly_chart(fig1)

    # Evoluci√≥n del valor monetario con Plotly
    st.subheader("üíµ Evoluci√≥n del Valor del Portafolio")
    fig2 = go.Figure()
    fig2.add_trace(go.Scatter(x=valor_portafolio.index, y=valor_portafolio.values,
                            mode='lines', name='Portafolio', line=dict(color='green')))
    fig2.update_layout(title="Evoluci√≥n del valor monetario del portafolio",
                      xaxis_title="Fecha", yaxis_title="Valor (USD)")
    st.plotly_chart(fig2)

    # Diagrama riesgo - retorno
    st.subheader("üìä Diagrama Riesgo - Retorno")
    asset_returns = mean_returns[tickers]
    asset_risk = returns[tickers].std() * np.sqrt(252)

    fig3, ax3 = plt.subplots(figsize=(7, 5))
    ax3.scatter(asset_risk.values, asset_returns.values, c='blue', s=80)
    for i, ticker in enumerate(tickers):
        ax3.text(asset_risk.values[i] + 0.002, asset_returns.values[i], ticker, fontsize=9, ha='left', va='center')
    ax3.set_xlabel("Volatilidad (Riesgo)")
    ax3.set_ylabel("Rendimiento Esperado")
    ax3.set_title("Diagrama Riesgo - Retorno")
    ax3.grid(True, linestyle='--', alpha=0.6)
    st.pyplot(fig3)

    # Heatmap de correlaciones con Plotly
    st.subheader("üî• Heatmap de Correlaciones")
    corr_matrix = returns[tickers].corr()
    fig4 = px.imshow(corr_matrix, text_auto=True, aspect="auto",
                    color_continuous_scale='RdBu_r', title="Matriz de Correlaciones")
    st.plotly_chart(fig4)

    # Visualizaci√≥n del portafolio
    st.subheader("ü•ß Distribuci√≥n del Portafolio")
    fig5 = go.Figure(data=[go.Pie(labels=tickers, values=weights, hole=0.3)])
    fig5.update_layout(title=f"Distribuci√≥n del Portafolio ({escenario})")
    st.plotly_chart(fig5)

    # Interpretaci√≥n del escenario
    st.markdown("---")
    st.subheader("üß† Interpretaci√≥n del Escenario Seleccionado")
    if escenario == "Conservador":
        st.info("üü© Este portafolio busca minimizar el riesgo, con un enfoque en estabilidad. Su rendimiento esperado es menor, pero ofrece menor volatilidad y p√©rdidas potenciales.")
    elif escenario == "Moderado":
        st.info("üü® Este portafolio equilibra riesgo y rendimiento. Es ideal para inversores con tolerancia media al riesgo que buscan un crecimiento sostenido.")
    elif escenario == "Agresivo":
        st.info("üü• Este portafolio asume mayor riesgo con el objetivo de maximizar el rendimiento. Es adecuado para inversionistas con alta tolerancia a la volatilidad y posibles p√©rdidas.")
    else:
        st.info("üìä Portafolio personalizado con pesos definidos manualmente. Revise las m√©tricas para evaluar el balance riesgo-rendimiento.")

    # Solo mostrar comparaci√≥n de escenarios si no es personalizado
    if escenario != "Personalizado":
        # Comparaci√≥n de escenarios
        st.subheader("üìä Comparaci√≥n de Escenarios de Inversi√≥n")
        fig_all, axs = plt.subplots(1, 3, figsize=(12, 4))
        for i, (nombre, base_pesos) in enumerate({
            "Conservador": np.linspace(0.6, 0.1, len(tickers)),
            "Moderado": np.linspace(0.4, 0.2, len(tickers)),
            "Agresivo": np.linspace(0.2, 0.6, len(tickers))
        }.items()):
            w = base_pesos / np.sum(base_pesos)
            labels = tickers[:len(w)]
            axs[i].pie(w, labels=labels, autopct='%1.1f%%', startangle=90)
            axs[i].set_title(nombre)
        plt.suptitle("Distribuci√≥n de Pesos por Tipo de Portafolio")
        st.pyplot(fig_all)

        # Evaluaci√≥n y recomendaci√≥n de escenarios
        st.subheader("ü§ñ Recomendaci√≥n de Escenario √ìptimo")
        resultados = {}
        for nombre, pesos in {
            "Conservador": np.linspace(0.6, 0.1, len(tickers)),
            "Moderado": np.linspace(0.4, 0.2, len(tickers)),
            "Agresivo": np.linspace(0.2, 0.6, len(tickers))
        }.items():
            w = pesos / np.sum(pesos)
            rendimiento = np.dot(w, mean_returns)
            riesgo = np.sqrt(np.dot(w.T, np.dot(cov_matrix, w)))
            sharpe = rendimiento / riesgo
            resultados[nombre] = {"rendimiento": rendimiento, "riesgo": riesgo, "sharpe": sharpe}

        df_resultados = pd.DataFrame(resultados).T
        df_resultados = df_resultados.sort_values("sharpe", ascending=False)

        st.dataframe(df_resultados.style.format({
            "rendimiento": "{:.2%}",
            "riesgo": "{:.2%}",
            "sharpe": "{:.2f}"
        }))

        mejor_escenario = df_resultados.index[0]
        st.success(f"‚úÖ El escenario m√°s eficiente seg√∫n el Ratio de Sharpe es: **{mejor_escenario}** üéØ")

        if mejor_escenario == "Conservador":
            st.info("üí° Recomendaci√≥n: Este portafolio ofrece mayor estabilidad y menor riesgo. Ideal para perfiles que priorizan seguridad sobre rentabilidad.")
        elif mejor_escenario == "Moderado":
            st.info("üí° Recomendaci√≥n: Este portafolio equilibra riesgo y rendimiento, siendo adecuado para inversores con tolerancia media al riesgo.")
        else:
            st.info("üí° Recomendaci√≥n: Este portafolio maximiza el rendimiento a costa de mayor volatilidad. Ideal para perfiles arriesgados que buscan crecimiento a largo plazo.")

    # Descarga de resultados
    st.subheader("üì• Descarga de Resultados")

    # Exportar datos a Excel
    excel_buffer = BytesIO()
    with pd.ExcelWriter(excel_buffer, engine='xlsxwriter') as writer:
        data.to_excel(writer, sheet_name='Precios')
        returns.to_excel(writer, sheet_name='Rendimientos')
        if escenario != "Personalizado":
            df_resultados.to_excel(writer, sheet_name='Escenarios')

    st.download_button(
        label="üìä Descargar en Excel",
        data=excel_buffer.getvalue(),
        file_name="analisis_portafolio.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

    # Generar reporte PDF
    st.subheader("üìÑ Generar Reporte en PDF")
    pdf_buffer = BytesIO()

    # Crear documento
    doc = SimpleDocTemplate(pdf_buffer, pagesize=letter)
    styles = getSampleStyleSheet()
    elements = []

    # T√≠tulo
    title = Paragraph("<b><font size=18 color='#004aad'>SMART PORTAFOLIO - REPORTE DE INVERSI√ìN</font></b>", styles["Title"])
    elements.append(title)
    elements.append(Spacer(1, 0.2 * inch))

    # Datos generales
    intro = Paragraph(f"""
    <font size=12>
    <b>Escenario seleccionado:</b> {escenario}<br/>
    <b>Activos analizados:</b> {', '.join(tickers)}<br/>
    <b>Inversi√≥n inicial:</b> ${inversion_inicial:,.2f}
    </font>
    """, styles["Normal"])
    elements.append(intro)
    elements.append(Spacer(1, 0.2 * inch))

    # Resultados
    resumen_data = [
        ["M√©trica", "Valor"],
        ["Rendimiento esperado", f"{port_return:.2%}"],
        ["Volatilidad esperada", f"{port_volatility:.2%}"],
        ["Ratio de Sharpe", f"{sharpe_ratio:.2f}"],
    ]
    
    if escenario != "Personalizado":
        resumen_data.append(["Escenario recomendado", mejor_escenario])

    table = Table(resumen_data, hAlign='LEFT')
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.lightblue),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.black),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 10),
        ('BACKGROUND', (0, 1), (-1, -1), colors.whitesmoke),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
    ]))
    elements.append(table)
    elements.append(Spacer(1, 0.3 * inch))

    # Conclusi√≥n
    if escenario != "Personalizado":
        conclusion = Paragraph(f"""
        <font size=12>
        La simulaci√≥n de escenarios permite observar c√≥mo el riesgo y el rendimiento est√°n estrechamente relacionados.<br/>
        El portafolio <b>{mejor_escenario}</b> presenta la mejor eficiencia seg√∫n el Ratio de Sharpe.<br/><br/>
        <b>Interpretaci√≥n:</b><br/>
        {("Este portafolio prioriza la estabilidad, ideal para perfiles conservadores." if mejor_escenario == "Conservador" 
        else "Este portafolio equilibra riesgo y rendimiento, ideal para inversores moderados." 
        if mejor_escenario == "Moderado" 
        else "Este portafolio busca maximizar ganancias, ideal para perfiles arriesgados.")}
        </font>
        """, styles["Normal"])
    else:
        conclusion = Paragraph(f"""
        <font size=12>
        Portafolio personalizado con distribuci√≥n espec√≠fica seg√∫n preferencias del usuario.<br/>
        <b>Rendimiento esperado:</b> {port_return:.2%}<br/>
        <b>Volatilidad esperada:</b> {port_volatility:.2%}<br/>
        <b>Eficiencia (Sharpe):</b> {sharpe_ratio:.2f}<br/>
        </font>
        """, styles["Normal"])
    
    elements.append(conclusion)

    # Guardar PDF
    doc.build(elements)
    pdf_buffer.seek(0)

    st.download_button(
        label="üìë Descargar Reporte en PDF",
        data=pdf_buffer,
        file_name="Reporte_Portafolio.pdf",
        mime="application/pdf"
    )

else:
    st.info("üëà Configura los par√°metros en la barra lateral y haz clic en 'Descargar y Analizar' para comenzar el an√°lisis.")
