# -*- coding: utf-8 -*-
"""Analisis_Portafolios.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OHRI3VCCTIOc3M4eLd18hLDRVqrlBv_n
"""

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import matplotlib.pyplot as plt

st.title ("üíº Smart Portafolio")
st.write("""
Esta aplicaci√≥n analiza un portafolio de inversi√≥n aplicando la **Teor√≠a Moderna de Portafolios de Markowitz**.
Se simulan tres escenarios (Conservador, Moderado y Agresivo) para observar c√≥mo var√≠an el riesgo, el rendimiento y la composici√≥n de activos.
Los datos se obtienen directamente desde **Yahoo Finance**, y los activos seleccionados pertenecen al sector tecnol√≥gico.
""")

# Validaci√≥n de tickers
def validar_tickers(tickers):
    tickers_validos = []
    for ticker in tickers:
        try:
            info = yf.Ticker(ticker).info
            if info.get('regularMarketPrice') is not None:
                tickers_validos.append(ticker)
        except:
            st.warning(f"‚ö†Ô∏è Ticker {ticker} no v√°lido")
    return tickers_validos

# Ejecutar an√°lisis al hacer clic
if descargar:
    if len(tickers) == 0:
        st.error("‚ùå Ingresa al menos un ticker")
        st.stop()
    
    tickers = validar_tickers(tickers)
    
    if len(tickers) == 0:
        st.error("‚ùå No hay tickers v√°lidos")
        st.stop()

    # Descargar datos
    with st.spinner('üì• Descargando datos...'):
        data = yf.download(tickers, start=fecha_inicio, end=fecha_fin)["Close"]
    
    # Mostrar datos
    st.subheader("üìä Datos Descargados")
    st.dataframe(data.tail())

    # Ajustar frecuencia
    if frecuencia == "Semanal":
        data = data.resample('W').last()
    elif frecuencia == "Mensual":
        data = data.resample('M').last()

    # --- NUEVO: Input de pesos personalizados ---
    st.sidebar.markdown("### üéØ Configuraci√≥n de Pesos")
    opcion_pesos = st.sidebar.radio(
        "M√©todo de asignaci√≥n:",
        ["Escenario Predefinido", "Pesos Personalizados"]
    )

    if opcion_pesos == "Escenario Predefinido":
        escenario = st.sidebar.selectbox("üí∞ Escenario", ["Conservador", "Moderado", "Agresivo"])
        escenarios = {
            "Conservador": np.linspace(0.6, 0.1, len(tickers)),
            "Moderado": np.linspace(0.4, 0.2, len(tickers)),
            "Agresivo": np.linspace(0.2, 0.6, len(tickers))
        }
        weights = escenarios[escenario]
        weights = weights / np.sum(weights)
    else:
        st.sidebar.markdown("### üî¢ Pesos Manuales")
        pesos_manuales = []
        total = 0
        for i, ticker in enumerate(tickers):
            peso = st.sidebar.slider(f"{ticker}", 0.0, 1.0, 1.0/len(tickers), 0.01)
            pesos_manuales.append(peso)
            total += peso
        
        if abs(total - 1.0) > 0.01:
            st.sidebar.warning(f"‚ö†Ô∏è Suma: {total:.2f}. Normalizando...")
            weights = np.array(pesos_manuales) / total
        else:
            weights = np.array(pesos_manuales)
        
        escenario = "Personalizado"

    # --- C√ÅLCULOS PRINCIPALES (mantener tus c√°lculos actuales) ---
    returns = data.pct_change().dropna()
    mean_returns = returns.mean() * 252
    cov_matrix = returns.cov() * 252

    port_return = np.dot(weights, mean_returns)
    port_volatility = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights)))
    sharpe_ratio = port_return / port_volatility

    returns["Portfolio"] = (returns[tickers] * weights).sum(axis=1)
    valor_portafolio = (1 + returns["Portfolio"]).cumprod() * inversion_inicial

    # --- NUEVO: M√©tricas en columnas ---
    st.subheader("üéØ Resumen Ejecutivo")
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Rendimiento Esperado", f"{port_return:.2%}")
    with col2:
        st.metric("Volatilidad Anual", f"{port_volatility:.2%}")
    with col3:
        st.metric("Ratio de Sharpe", f"{sharpe_ratio:.2f}")
    with col4:
        st.metric("Escenario", escenario)

    # --- NUEVO: Gr√°fico interactivo con Plotly ---
    st.subheader("üìà Evoluci√≥n del Portafolio")
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=valor_portafolio.index, y=valor_portafolio.values,
                            mode='lines', name='Tu Portafolio', line=dict(color='green')))
    fig.update_layout(title="Evoluci√≥n del Valor del Portafolio",
                     xaxis_title="Fecha", yaxis_title="Valor (USD)")
    st.plotly_chart(fig)

    # --- MANTENER: Tus gr√°ficos existentes (pero opcional cambiar a Plotly) ---
    st.subheader("üìä Diagrama Riesgo - Retorno")
    asset_returns = mean_returns[tickers]
    asset_risk = returns[tickers].std() * np.sqrt(252)

    fig3, ax3 = plt.subplots(figsize=(7, 5))
    ax3.scatter(asset_risk.values, asset_returns.values, c='blue', s=80)
    for i, ticker in enumerate(tickers):
        ax3.text(asset_risk.values[i] + 0.002, asset_returns.values[i], ticker, fontsize=9)
    ax3.set_xlabel("Volatilidad (Riesgo)")
    ax3.set_ylabel("Rendimiento Esperado")
    ax3.grid(True, linestyle='--', alpha=0.6)
    st.pyplot(fig3)

    # --- NUEVO: Heatmap interactivo de correlaciones ---
    st.subheader("üî• Heatmap de Correlaciones")
    corr_matrix = returns[tickers].corr()
    fig_corr = px.imshow(corr_matrix, text_auto=True, aspect="auto",
                        color_continuous_scale='RdBu_r')
    st.plotly_chart(fig_corr)

    # --- MANTENER: El resto de tu c√≥digo original ---
    # (Pie charts, comparaci√≥n de escenarios, recomendaci√≥n, descargas)
    # ... [todo lo que tienes despu√©s del diagrama riesgo-retorno se mantiene igual]

else:
    st.info("üëà Configura los par√°metros en la barra lateral y haz clic en 'Descargar y Analizar'")
